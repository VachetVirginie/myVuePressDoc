{"remainingRequest":"/Users/vivi./Dev/myVuePressDoc/node_modules/vue-loader/lib/index.js??ref--1-1!/Users/vivi./Dev/myVuePressDoc/node_modules/vuepress/lib/webpack/markdownLoader.js??ref--1-2!/Users/vivi./Dev/myVuePressDoc/docs/symfony/eventlistener.md?vue&type=template&id=e3c5916e&","dependencies":[{"path":"/Users/vivi./Dev/myVuePressDoc/docs/symfony/eventlistener.md","mtime":1631613175244},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/cache-loader/dist/cjs.js","mtime":1660115262090},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/cache-loader/dist/cjs.js","mtime":1660115262090},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/babel-loader/lib/index.js","mtime":1660115261629},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/vue-loader/lib/loaders/templateLoader.js","mtime":1660115262578},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/cache-loader/dist/cjs.js","mtime":1660115262090},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/vue-loader/lib/index.js","mtime":1660115262578},{"path":"/Users/vivi./Dev/myVuePressDoc/node_modules/vuepress/lib/webpack/markdownLoader.js","mtime":1660115261540}],"contextDependencies":[],"result":["\n<div class=\"content\"><h1 id=\"automatiser-des-actions-avec-les-«-event-listeners-»-de-doctrine\"><a class=\"header-anchor\" href=\"#automatiser-des-actions-avec-les-«-event-listeners-»-de-doctrine\" aria-hidden=\"true\">#</a> Automatiser des actions avec les « Event listeners » de doctrine</h1>\n<p>Le framework Symfony couplé à l'ORM doctrine permet de créer des « Event Listeners », c'est à dire connaitre dés qu'il y'a un événement (création/modification/suppression) sur une entité. C'est un outil très intéressant pour automatiser des actions quand certaines propriétés d'une entité sont mis à jour.</p>\n<p>Prenons un exemple concret : Dans les semaines précédentes, nous avons vu comment <a href=\"https://numa-bord.com/miniblog/php-google-map-api-recuperer-coordonees-gps-depuis-adresse-format-humain/\" target=\"_blank\" rel=\"noopener noreferrer\">récupérer les coordonnées d'une adresse grâce à l'API google map<OutboundLink/></a>. Afin de limiter les appels à l'API google map (payants si un certain quota et dépassé) nous allons enregistrer ces coordonnées en base de données pour pouvoir les réutiliser directement. Il nous faut cependant les enregistrer/mettre à jour à chaque fois qu'une adresse est crée ou modifiée. C'est ici que nous faisons intervenir les Event Listener.</p>\n<p>Commençons par configurer nos listeners dans les services (fichiers services.yml du dossier /app/config/) de symfony.</p>\n<!--beforebegin--><div class=\"language- extra-class\"><!--afterbegin--><pre v-pre class=\"language-text\"><code>services:\\\n   #...\\\n    #LISTENER DOCTRINE#\\\n    app.listener.doctrineevent:\\\n        class: AppBundle\\EventListener\\DoctrineEvent\\\n        tags:\\\n            - { name: doctrine.event_listener, event: prePersist, lazy: true }\\\n            - { name: doctrine.event_listener, event: preUpdate, lazy: true }\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>La configuration indique que nous allons écouter les événements « PrePersist » et « PreUpdate ». Ce qui permettra d'effectuer notre action lors de la création d'une adresse et lors de sa modification. Créons la classe qui va gérer tout ça. Comme indiqué il s'agit du fichier : AppBundle\\EventListener\\DoctrineEvent</p>\n<p>Pour appréhender la suite, consultez les commentaires dans le code</p>\n<!--beforebegin--><div class=\"language- extra-class\"><!--afterbegin--><pre v-pre class=\"language-text\"><code>namespace AppBundle\\EventListener;\n\nuse Doctrine\\Common\\EventSubscriber;\\\nuse Doctrine\\Common\\Persistence\\Event\\LifecycleEventArgs;\\\n//les adresses de nos utilisateur sont stockés dans une entité &quot;Contact&quot;\\\nuse AppBundle\\Entity\\Contact;\n\nclass DoctrineEvent implements EventSubscriber {\n\n    public function getSubscribedEvents() {\\\n        return [array](http://www.php.net/array)(&#39;prePersist&#39;, &#39;preUpdate&#39;);//les événements écoutés\\\n    }\n\n    public function prePersist(LifecycleEventArgs $args) {\\\n        $entity = $args-&gt;getEntity();\\\n        //Si c&#39;est bien une entité Contact qui va être &quot;persisté&quot;\\\n        if ($entity instanceof Contact) {\\\n            $entity-&gt;updateGmapData();//on met à jour les coordonnées via l&#39;appel à google map\\\n        }\\\n    }\n\n    public function preUpdate(LifecycleEventArgs $args) {\\\n        $entity = $args-&gt;getEntity();\\\n        $changeset = $args-&gt;getEntityManager()-&gt;getUnitOfWork()-&gt;getEntityChangeSet($entity);\\\n        //Si c&#39;est bien une entité Contact qui va être modifié\\\n        if ($entity instanceof Contact) {\\\n            //Si il y&#39;a eu une mise a jour sur les propriétés en relation avec l&#39;adresse (ici &quot;address&quot;, &quot;city&quot; et &quot;postalCode&quot;)\\\n            if ([array_key_exists](http://www.php.net/array_key_exists)(&quot;address&quot;, $changeset) || [array_key_exists](http://www.php.net/array_key_exists)(&quot;city&quot;, $changeset) || [array_key_exists](http://www.php.net/array_key_exists)(&quot;postalCode&quot;, $changeset)) {\\\n                $entity-&gt;updateGmapData();//on met à jour les coordonnées via l&#39;appel à google map\\\n            }\\\n        }\\\n    }\n\n}\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>De cette manière nos coordonnées seront toujours à jour. Il manque pour que l'exemple soit complet la fonction « updateGmapData() » de notre entité Contact. Cela ne concerne pas le sujet des Event Listener, mais je vous en met un exemple qui utilise bien sur la fonction « geocodeAddress() » détaillé <a href=\"https://numa-bord.com/miniblog/php-google-map-api-recuperer-coordonees-gps-depuis-adresse-format-humain/\" target=\"_blank\" rel=\"noopener noreferrer\">ici<OutboundLink/></a></p>\n<!--beforebegin--><div class=\"language- extra-class\"><!--afterbegin--><pre v-pre class=\"language-text\"><code>    public function updateGmapData() {\\\n        $data = \\AppBundle\\Utils\\GmapApi::geocodeAddress($this-&gt;getAddress() . &#39; &#39; . $this-&gt;getZipcode() . &#39; &#39; . $this-&gt;getCity());\\\n        $this-&gt;setGmapLat($data[&#39;lat&#39;]);\\\n        $this-&gt;setGmapLng($data[&#39;lng&#39;]);\\\n        $this-&gt;setGmapAddress($data[&#39;address&#39;]);\\\n        $this-&gt;setGmapPostalCode($data[&#39;postal_code&#39;]);\\\n        $this-&gt;setGmapCity($data[&#39;city&#39;]);\\\n        $this-&gt;setGmapDepartment($data[&#39;department&#39;]);\\\n        $this-&gt;setGmapRegion($data[&#39;region&#39;]);\\\n        $this-&gt;setGmapCountry($data[&#39;country&#39;]);\\\n    }\n</code></pre>\n<!--beforeend--></div><!--afterend--></div>\n",null]}